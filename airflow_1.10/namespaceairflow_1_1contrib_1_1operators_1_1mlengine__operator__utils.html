<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>airflow_1.10.0_stable: airflow.contrib.operators.mlengine_operator_utils Namespace Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">airflow_1.10.0_stable
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="namespaceairflow.html">airflow</a></li><li class="navelem"><a class="el" href="namespaceairflow_1_1contrib.html">contrib</a></li><li class="navelem"><a class="el" href="namespaceairflow_1_1contrib_1_1operators.html">operators</a></li><li class="navelem"><a class="el" href="namespaceairflow_1_1contrib_1_1operators_1_1mlengine__operator__utils.html">mlengine_operator_utils</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">airflow.contrib.operators.mlengine_operator_utils Namespace Reference</div>  </div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ad7ad94aa6b42b147ef0dfa0b97cd70c4"><td class="memItemLeft" align="right" valign="top">def&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespaceairflow_1_1contrib_1_1operators_1_1mlengine__operator__utils.html#ad7ad94aa6b42b147ef0dfa0b97cd70c4">create_evaluate_ops</a> (task_prefix, data_format, input_paths, prediction_path, metric_fn_and_keys, validate_fn, batch_prediction_job_id=None, project_id=None, region=None, dataflow_options=None, model_uri=None, model_name=None, version_name=None, dag=None)</td></tr>
<tr class="separator:ad7ad94aa6b42b147ef0dfa0b97cd70c4"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a id="ad7ad94aa6b42b147ef0dfa0b97cd70c4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad7ad94aa6b42b147ef0dfa0b97cd70c4">&#9670;&nbsp;</a></span>create_evaluate_ops()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">def airflow.contrib.operators.mlengine_operator_utils.create_evaluate_ops </td>
          <td>(</td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>task_prefix</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>data_format</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>input_paths</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>prediction_path</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>metric_fn_and_keys</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>validate_fn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>batch_prediction_job_id</em> = <code>None</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>project_id</em> = <code>None</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>region</em> = <code>None</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>dataflow_options</em> = <code>None</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>model_uri</em> = <code>None</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>model_name</em> = <code>None</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>version_name</em> = <code>None</code>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&#160;</td>
          <td class="paramname"><em>dag</em> = <code>None</code>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">Creates Operators needed for model evaluation and returns.

It gets prediction over inputs via Cloud ML Engine BatchPrediction API by
calling MLEngineBatchPredictionOperator, then summarize and validate
the result via Cloud Dataflow using DataFlowPythonOperator.

For details and pricing about Batch prediction, please refer to the website
https://cloud.google.com/ml-engine/docs/how-tos/batch-predict
and for Cloud Dataflow, https://cloud.google.com/dataflow/docs/

It returns three chained operators for prediction, summary, and validation,
named as &lt;prefix&gt;-prediction, &lt;prefix&gt;-summary, and &lt;prefix&gt;-validation,
respectively.
(&lt;prefix&gt; should contain only alphanumeric characters or hyphen.)

The upstream and downstream can be set accordingly like:
  pred, _, val = create_evaluate_ops(...)
  pred.set_upstream(upstream_op)
  ...
  downstream_op.set_upstream(val)

Callers will provide two python callables, metric_fn and validate_fn, in
order to customize the evaluation behavior as they wish.
- metric_fn receives a dictionary per instance derived from json in the
  batch prediction result. The keys might vary depending on the model.
  It should return a tuple of metrics.
- validation_fn receives a dictionary of the averaged metrics that metric_fn
  generated over all instances.
  The key/value of the dictionary matches to what's given by
  metric_fn_and_keys arg.
  The dictionary contains an additional metric, 'count' to represent the
  total number of instances received for evaluation.
  The function would raise an exception to mark the task as failed, in a
  case the validation result is not okay to proceed (i.e. to set the trained
  version as default).

Typical examples are like this:

def get_metric_fn_and_keys():
    import math  # imports should be outside of the metric_fn below.
    def error_and_squared_error(inst):
        label = float(inst['input_label'])
        classes = float(inst['classes'])  # 0 or 1
        err = abs(classes-label)
        squared_err = math.pow(classes-label, 2)
        return (err, squared_err)  # returns a tuple.
    return error_and_squared_error, ['err', 'mse']  # key order must match.

def validate_err_and_count(summary):
    if summary['err'] &gt; 0.2:
        raise ValueError('Too high err&gt;0.2; summary=%s' % summary)
    if summary['mse'] &gt; 0.05:
        raise ValueError('Too high mse&gt;0.05; summary=%s' % summary)
    if summary['count'] &lt; 1000:
        raise ValueError('Too few instances&lt;1000; summary=%s' % summary)
    return summary

For the details on the other BatchPrediction-related arguments (project_id,
job_id, region, data_format, input_paths, prediction_path, model_uri),
please refer to MLEngineBatchPredictionOperator too.

:param task_prefix: a prefix for the tasks. Only alphanumeric characters and
    hyphen are allowed (no underscores), since this will be used as dataflow
    job name, which doesn't allow other characters.
:type task_prefix: string

:param data_format: either of 'TEXT', 'TF_RECORD', 'TF_RECORD_GZIP'
:type data_format: string

:param input_paths: a list of input paths to be sent to BatchPrediction.
:type input_paths: list of strings

:param prediction_path: GCS path to put the prediction results in.
:type prediction_path: string

:param metric_fn_and_keys: a tuple of metric_fn and metric_keys:
    - metric_fn is a function that accepts a dictionary (for an instance),
      and returns a tuple of metric(s) that it calculates.
    - metric_keys is a list of strings to denote the key of each metric.
:type metric_fn_and_keys: tuple of a function and a list of strings

:param validate_fn: a function to validate whether the averaged metric(s) is
    good enough to push the model.
:type validate_fn: function

:param batch_prediction_job_id: the id to use for the Cloud ML Batch
    prediction job. Passed directly to the MLEngineBatchPredictionOperator as
    the job_id argument.
:type batch_prediction_job_id: string

:param project_id: the Google Cloud Platform project id in which to execute
    Cloud ML Batch Prediction and Dataflow jobs. If None, then the `dag`'s
    `default_args['project_id']` will be used.
:type project_id: string

:param region: the Google Cloud Platform region in which to execute Cloud ML
    Batch Prediction and Dataflow jobs. If None, then the `dag`'s
    `default_args['region']` will be used.
:type region: string

:param dataflow_options: options to run Dataflow jobs. If None, then the
    `dag`'s `default_args['dataflow_default_options']` will be used.
:type dataflow_options: dictionary

:param model_uri: GCS path of the model exported by Tensorflow using
    tensorflow.estimator.export_savedmodel(). It cannot be used with
    model_name or version_name below. See MLEngineBatchPredictionOperator for
    more detail.
:type model_uri: string

:param model_name: Used to indicate a model to use for prediction. Can be
    used in combination with version_name, but cannot be used together with
    model_uri. See MLEngineBatchPredictionOperator for more detail. If None,
    then the `dag`'s `default_args['model_name']` will be used.
:type model_name: string

:param version_name: Used to indicate a model version to use for prediciton,
    in combination with model_name. Cannot be used together with model_uri.
    See MLEngineBatchPredictionOperator for more detail. If None, then the
    `dag`'s `default_args['version_name']` will be used.
:type version_name: string

:param dag: The `DAG` to use for all Operators.
:type dag: airflow.DAG

:returns: a tuple of three operators, (prediction, summary, validation)
:rtype: tuple(DataFlowPythonOperator, DataFlowPythonOperator,
              PythonOperator)
</pre> 
<p class="definition">Definition at line <a class="el" href="mlengine__operator__utils_8py_source.html#l00045">45</a> of file <a class="el" href="mlengine__operator__utils_8py_source.html">mlengine_operator_utils.py</a>.</p>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
